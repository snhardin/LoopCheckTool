<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <BranchFile>$(IntermediateOutputPath)GitBranch</BranchFile>
    <GITHUB_RUN_NUMBER Condition=" '$(GITHUB_RUN_NUMBER)' == '' ">0</GITHUB_RUN_NUMBER>
    <CustomAssemblyInfoFileName>CustomAssemblyInfo.cs</CustomAssemblyInfoFileName>
    <HashFile>$(IntermediateOutputPath)GitHash</HashFile>
  </PropertyGroup>
  <Target Name="CustomAssemblyInfo" BeforeTargets="CoreCompile">
    <PropertyGroup>
      <VersionFile>$(ProjectDir)VERSION</VersionFile>
    </PropertyGroup>
    <Exec Command="git -C $(ProjectDir) describe --long --always --dirty &gt; $(HashFile)" />
    <ReadLinesFromFile File="$(HashFile)">
      <Output TaskParameter="Lines" ItemName="GitCommit" />
    </ReadLinesFromFile>

    <Exec Command="git -C $(ProjectDir) rev-parse --abbrev-ref HEAD &gt; $(BranchFile)" />
    <ReadLinesFromFile File="$(BranchFile)">
      <Output TaskParameter="Lines" ItemName="GitBranch" />
    </ReadLinesFromFile>

    <ReadLinesFromFile File="$(VersionFile)">
      <Output TaskParameter="Lines" ItemName="UserDefinedVersion" />
    </ReadLinesFromFile>

    <ItemGroup>
      <AssemblyAttributes Include="AssemblyTitle">
        <_Parameter1>$(AssemblyName)</_Parameter1>
      </AssemblyAttributes>
      <AssemblyAttributes Include="AssemblyProduct">
        <_Parameter1>$(AssemblyName)</_Parameter1>
      </AssemblyAttributes>
      <AssemblyAttributes Include="AssemblyVersion">
        <!-- Should be major version only per Microsoft guidelines. -->
        <_Parameter1>@(UserDefinedVersion).0</_Parameter1>
      </AssemblyAttributes>
      <AssemblyAttributes Include="AssemblyFileVersion">
        <_Parameter1>@(UserDefinedVersion).$(GITHUB_RUN_NUMBER)</_Parameter1>
      </AssemblyAttributes>
      <AssemblyAttributes Include="AssemblyInformationalVersion">
        <!-- This should be the Git Tagged version. -->
        <_Parameter1>0.0.0.0</_Parameter1>
      </AssemblyAttributes>
      <AssemblyAttributes Include="AssemblyMetadata">
        <_Parameter1>GitCommit</_Parameter1>
        <_Parameter2>@(GitCommit)</_Parameter2>
      </AssemblyAttributes>
      <AssemblyAttributes Include="AssemblyMetadata">
        <_Parameter1>GitBranch</_Parameter1>
        <_Parameter2>@(GitBranch)</_Parameter2>
      </AssemblyAttributes>
    </ItemGroup>
    <!-- See https://stackoverflow.com/questions/4300346/using-writecodefragment-msbuild-task -->
    <WriteCodeFragment Language="C#"
                       OutputDirectory="$(IntermediateOutputPath)"
                       OutputFile="$(CustomAssemblyInfoFileName)"
                       AssemblyAttributes="@(AssemblyAttributes)">
      <Output TaskParameter="OutputFile" ItemName="Compile" />
      <Output TaskParameter="OutputFile" ItemName="FileWrites" />
    </WriteCodeFragment>
    <ItemGroup>
      <FileWrites Include="$(BranchFile)" />
      <FileWrites Include="$(HashFile)" />
    </ItemGroup>
  </Target>
</Project>
